syntax = "proto3";
package snaking;
option go_package = "./pb";

service Controller {
    rpc PostError (ErrorMessage) returns (Empty);
    rpc WaitForStart (Empty) returns (StartConfig);
    rpc SyncStep (StepStatus) returns (StepResponse);
    rpc Register (RegisterInfo) returns (RegisteredMessage);
    rpc FinishPreprocess (PreprocessFinished) returns (Empty);
    rpc HeartBeat (HeartbeatInfo) returns (HeartbeatResponse);
    rpc ResourceReady (SuccessMessage) returns (SuccessMessage);

    rpc ControlChannel (stream WorkerStreamMessage) returns (stream OrchestratorStreamMessage);
}

message Empty {}

enum WorkerStreamMessageType {
    WSM_UNKNOWN = 0;
    WSM_REGISTER = 1;
    WSM_HEARTBEAT = 2;
    WSM_HANGUP = 3;
    WSM_ERROR = 4;
}

message WorkerStreamMessage {
    string worker_id = 1;
    string message_id = 2;
    WorkerStreamMessageType type = 3;
    string payload = 4;
}

enum OrchestratorStreamMessageType {
    OSM_UNKNOWN = 0;
    OSM_ACKNOWLEDGE = 1;
    OSM_COMMAND = 2;
}

message OrchestratorStreamMessage {
    OrchestratorStreamMessageType type = 1;
    string message_id = 2;
    string payload = 3;
}

message WorkerStatus {
    string worker_id = 1;
    int32 status = 2;
    string message = 3;
}

message ErrorMessage {
    string worker_id = 1;
    string message = 2;
}

message RegisterInfo {
    string worker_id = 1;
}

message RegisteredMessage {
    bool success = 1;
    string shared_data_path = 2;
}

message PreprocessFinished {
    string worker_id = 1;
}

message HeartbeatInfo {
    string worker_id = 1;
    int32 status = 2;
}

message HeartbeatResponse {
    int32 status = 1;
}

message SuccessMessage {
    bool success = 1;
}

message StartConfig {
    bool ready = 1;
    string shared_data_path = 2;
}

message StepStatus {
    string worker_id = 1;
    int32 current_step = 2;
}

message StepResponse {
    bool should_continue = 1;
}

message OrchestratorCommand {
    enum CommandType {
        UNKNOWN = 0;
        START = 1;
        RESUME = 2;
        STOP = 3;
        PAUSE = 4;
    }
    CommandType command = 1;
    string payload = 2;
}